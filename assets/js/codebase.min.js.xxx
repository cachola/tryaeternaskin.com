var cb=function($){"use strict";$(window).keydown((function(e){27===e.which&&$("#error_handler_overlay").length&&$("#error_handler_overlay").remove()})),$(document).off("click","#error_handler_overlay_close"),$(document).on("click","#error_handler_overlay_close",(function(event){event.preventDefault?event.preventDefault():event.returnValue=!1,$("#error_handler_overlay").remove()}));var validClass=app_config.valid_class,errorClass=app_config.error_class,loadingClass=app_config.loading_class,formActions={prospect:"prospect",fullprospect:"fullprospect",shipping:"shipping",checkout:"checkout",downsell1:"downsell",downsell2:"downsell",upsell:"upsell"},prospectFormFields={firstName:{},lastName:{},email:{validators:[["isValidEmail"]]},phone:{validators:[["isValidPhone"]]}},checkoutFormFields={billingSameAsShipping:{},billingFirstName:{condition:["billingSameAsShipping","no"]},billingLastName:{condition:["billingSameAsShipping","no"]},billingAddress1:{condition:["billingSameAsShipping","no"]},billingAddress2:{condition:["billingSameAsShipping","no"]},billingZip:{condition:["billingSameAsShipping","no"],validators:[["isValidZip","billingCountry"]]},billingCity:{condition:["billingSameAsShipping","no"]},billingState:{condition:["billingSameAsShipping","no"]},billingCountry:{condition:["billingSameAsShipping","no"]},cardType:{aliases:["creditCardType"]},cardNumber:{aliases:["creditCardNumber"],validators:[["isValidCardNumber","cardType"]]},cardExpiryMonth:{aliases:["expmonth"]},cardExpiryYear:{aliases:["expyear"]},cvv:{aliases:["CVV"],validators:[["isValidCvv"]]}},prospectForm={data:{},fields:prospectFormFields,errors:{}},fullProspectForm={data:{},fields:{firstName:{},lastName:{},email:{validators:[["isValidEmail"]]},phone:{validators:[["isValidPhone"]]},shippingAddress1:{},shippingAddress2:{},shippingZip:{validators:[["isValidZip","shippingCountry"]]},shippingCity:{},shippingState:{},shippingCountry:{}},errors:{}},checkoutForm={data:{},fields:checkoutFormFields,errors:{}},downsellForm={data:{},fields:$.extend(!0,{},prospectFormFields,checkoutFormFields),errors:{}};function performValidation(fieldName,validationMeta,form,inputElement){form.data[fieldName].value;switch(validationMeta.shift()){case"isValidEmail":!function(fieldName,inputElement,form){form.data[fieldName].value;var inputElementName=form.data[fieldName].name,value=inputElement.val().trim();form.errors[inputElementName]=inputElement.data("error-message"),inputElement.removeClass(validClass).addClass(errorClass),void 0===form.errors[inputElementName]&&(form.errors[inputElementName]="Enter a valid "+inputElementName.toUpperCase());if(!validator.isValidEmail(value))return;delete form.errors[inputElementName],inputElement.removeClass(errorClass).addClass(validClass)}(fieldName,inputElement,form);break;case"isValidPhone":!function(fieldName,inputElement,form){form.data[fieldName].value;var inputElementName=form.data[fieldName].name,value=inputElement.val().trim();form.errors[inputElementName]=inputElement.data("error-message"),inputElement.removeClass(validClass).addClass(errorClass),void 0===form.errors[inputElementName]&&(form.errors[inputElementName]="Enter a valid "+inputElementName.toUpperCase());if(!validator.isValidPhone(value))return;delete form.errors[inputElementName],inputElement.removeClass(errorClass).addClass(validClass)}(fieldName,inputElement,form);break;case"isValidZip":!function(fieldName,inputElement,form,validationMeta){form.data[fieldName].value;var inputElementName=form.data[fieldName].name,value=inputElement.val().trim();form.errors[inputElementName]=inputElement.data("error-message"),inputElement.removeClass(validClass).addClass(errorClass),void 0===form.errors[inputElementName]&&(form.errors[inputElementName]="Enter a valid "+inputElementName.toUpperCase());var country=form.data[validationMeta[0]].value;if(!validator.isValidZip(value,country))return;delete form.errors[inputElementName],inputElement.removeClass(errorClass).addClass(validClass)}(fieldName,inputElement,form,validationMeta);break;case"isValidCardNumber":!function(fieldName,inputElement,form,validationMeta){form.data[fieldName].value;var inputElementName=form.data[fieldName].name,cardNumber=inputElement.val().trim().replace(/[\s-]/g,"");form.errors[inputElementName]=inputElement.data("error-message"),inputElement.removeClass(validClass).addClass(errorClass),void 0===form.errors[inputElementName]&&(form.errors[inputElementName]="Enter a valid "+inputElementName.toUpperCase());var cardType=form.data[validationMeta[0]].value,isTestCard=!1;void 0!==app_config.allowed_tc&&app_config.allowed_tc.length&&$(app_config.allowed_tc).each((function(key,value){var testcardNumber=value.toString().split("|")[0];if(cardNumber===testcardNumber)return isTestCard=!0,!0}));if(!1===isTestCard&&!validator.isValidCardNumber(cardNumber,cardType))return;delete form.errors[inputElementName],inputElement.removeClass(errorClass).addClass(validClass)}(fieldName,inputElement,form,validationMeta);break;case"isValidCvv":!function(fieldName,inputElement,form,validationMeta){form.data[fieldName].value;var inputElementName=form.data[fieldName].name,value=inputElement.val();form.errors[inputElementName]=inputElement.data("error-message"),inputElement.removeClass(validClass).addClass(errorClass),void 0===form.errors[inputElementName]&&(form.errors[inputElementName]="Enter a valid "+inputElementName.toUpperCase());if(!validator.isValidCvv(value))return;delete form.errors[inputElementName],inputElement.removeClass(errorClass).addClass(validClass)}(fieldName,inputElement,form)}}function performRegularValidation(fieldName,form,inputElement){form.data[fieldName].value;var inputElementName=form.data[fieldName].name,value=inputElement.val().trim();if(form.errors[inputElementName]=inputElement.data("error-message"),inputElement.removeClass(validClass).addClass(errorClass),void 0===form.errors[inputElementName]&&(form.errors[inputElementName]="Enter a valid "+inputElementName.toUpperCase()),""!==value){var minLength=1,maxLength=100;void 0!==inputElement.data("min-length")&&(minLength=parseInt(inputElement.data("min-length"))),void 0!==inputElement.data("max-length")&&(maxLength=parseInt(inputElement.data("max-length"))),value.length<minLength||value.length>maxLength||(delete form.errors[inputElementName],inputElement.removeClass(errorClass).addClass(validClass))}}function loadInputData(fieldName,form,formElement){if(form.data[fieldName]={value:"",name:fieldName},formElement.find("[name="+fieldName+"]").length)return"radio"!==formElement.find('[name="'+fieldName+'"]').attr("type")?void(form.data[fieldName]={value:formElement.find('[name="'+fieldName+'"]').val(),name:fieldName}):void(form.data[fieldName]={value:formElement.find('[name="'+fieldName+'"]:checked').val(),name:fieldName});if(form.fields[fieldName].hasOwnProperty("aliases"))for(var ii in form.fields[fieldName].aliases){var name=form.fields[fieldName].aliases[ii];if(formElement.find('[name="'+name+'"]').length){if("radio"!==formElement.find('[name="'+name+'"]').attr("type")){form.data[fieldName]={value:formElement.find('[name="'+name+'"]').val(),name:name};break}form.data[fieldName]={value:formElement.find('[name="'+name+'"]:checked').val(),name:name};break}}else form.data[fieldName]={value:"",name:fieldName}}function renderAdditionalPixels(data){void 0!==data.submissionPixels&&(void 0!==data.submissionPixels.top&&data.submissionPixels.top&&$("body").prepend(data.submissionPixels.top),void 0!==data.submissionPixels.bottom&&data.submissionPixels.bottom&&$("body").append(data.submissionPixels.bottom),void 0!==data.submissionPixels.head&&data.submissionPixels.head&&$("head").append(data.submissionPixels.head)),void 0!==data.declinePixels&&(void 0!==data.declinePixels.top&&data.declinePixels.top&&$("body").prepend(data.declinePixels.top),void 0!==data.declinePixels.bottom&&data.declinePixels.bottom&&$("body").append(data.declinePixels.bottom),void 0!==data.declinePixels.head&&data.declinePixels.head&&$("head").append(data.declinePixels.head))}function redirectTo($redirect,data){if(window.onbeforeunload=null,app_config.cbtoken.length){var _form=$("<form />").attr({id:"redirect-to",method:"POST",action:$redirect}),_input=$("<input />").attr({name:"cbtoken",value:app_config.cbtoken});_form.append(_input),_form.appendTo("body"),_form.submit()}else-1!=(ua=navigator.userAgent.toLowerCase()).indexOf("msie")&&parseInt(ua.split("msie")[1])?window.location.replace($redirect):(void 0===data.skipQueryParams&&history.pushState({},null,data.redirect),window.location.assign($redirect));var ua}return{formElementSelectors:{firstName:"[name=firstName], [name$=FirstName]",lastName:"[name=lastName], [name$=LastName]",address1:"[name=address1], [name$=Address1]",address2:"[name=address2], [name$=Address2]",country:"[name=country], [name$=Country]",state:"[name=state], [name$=State]",city:"[name=city], [name$=City]",zip:"[name=zip], [name$=Zip]",email:"[name=email], [name$=Email]",phone:"[name=phone], [name$=Phone]",cardNumber:"[name=cardNumber], [name$=CardNumber]",cardType:"[name=cardType], [name$=CardType]",cardExpiryMonth:"[name=cardExpiryMonth], [name=expmonth]",cardExpiryYear:"[name=cardExpiryYear], [name=expyear]",cvv:"[name=cvv], [name=CVV]"},formActions:formActions,validateForm:function(formElement,formType){var form=function(formElement,formType){formElement.find("input, select").each((function(){$(this).removeClass("cb-loaded-field")}));var form={};switch(formType){case"prospect":form=$.extend(!0,{},prospectForm);break;case"fullprospect":form=$.extend(!0,{},fullProspectForm);break;case"checkout":form=$.extend(!0,{},checkoutForm);break;case"downsell":form=$.extend(!0,{},downsellForm);break;default:form={fields:{},data:{},errors:{}}}for(var fieldName in form.fields){if(form.fields[fieldName].hasOwnProperty("condition")){var condition=form.fields[fieldName].condition;if(form.data.hasOwnProperty(condition[0])||loadInputData(condition[0],form,formElement),form.data[condition[0]].value.toLowerCase()!==condition[1])continue}form.data.hasOwnProperty(fieldName)||loadInputData(fieldName,form,formElement),form.data[fieldName].hasOwnProperty("name")&&formElement.find('[name="'+form.data[fieldName].name+'"]').addClass("cb-loaded-field")}return formElement.find("input, select").not("[type=hidden], [type=submit]").each((function(){!$(this).hasClass("cb-loaded-field")&&$(this).attr("name")&&(form.fields[$(this).attr("name")]={},form.data[$(this).attr("name")]={value:$(this).val(),name:$(this).attr("name")})})),formElement.find("input, select").each((function(){$(this).removeClass("cb-loaded-field")})),form}(formElement,formType);for(var fieldName in form.data){var inputElementName=form.data[fieldName].name;if(0!==formElement.find('[name="'+inputElementName+'"]').length){var inputElement=formElement.find('[name="'+inputElementName+'"]');if(inputElement.hasClass("required"))if(inputElement.data("ignore")&&inputElement.has(errorClass))form.errors[inputElementName]=inputElement.data("error-message"),void 0===form.errors[inputElementName]&&(form.errors[inputElementName]="Enter a valid "+inputElementName.toUpperCase());else if(performRegularValidation(fieldName,form,inputElement),!form.errors.hasOwnProperty(fieldName)&&form.fields[fieldName].hasOwnProperty("validators"))for(var ii in form.fields[fieldName].validators){var str=JSON.stringify(form.fields[fieldName].validators[ii]);performValidation(fieldName,JSON.parse(str),form,inputElement)}}}return JSON.parse(JSON.stringify(form.errors))},submitForm:function(formElement,formOptions){for(var ii=0,len=cb.currentFormSubmitEvents.length;ii<len;ii++){var callable=cb.currentFormSubmitEvents[ii];return cb.currentFormSubmitEvents.splice(ii,1),void callable(formElement,formOptions)}var actionType=formActions[formOptions.type];$("input[name=altered_action]").length&&(actionType=$("input[name=altered_action]").val());var testFlag=location.search.match("test_flag")?"&test_flag=on":"";app_config.cbtoken.length&&app_config.cbtoken,$.ajax({url:app_config.offer_path+AJAX_PATH+actionType,method:"post",data:formElement.serialize()+testFlag,beforeSend:function(){$(formOptions.ajaxLoader.div).fadeIn(formOptions.ajaxLoader.timeInOut)},success:function(data){"object"!=typeof data&&(data=JSON.parse(data)),function(data,formElement,formOptions){if(data.success&&"is_html"in data&&1==data.is_html)return window.onbeforeunload=null,void function(data){var newDoc=document.open("text/html","replace");newDoc.write(data),newDoc.close()}(data.html);if(!0===data.success)"function"==typeof formOptions.onSuccess?formOptions.onSuccess(data):(redirectTo(data.redirect,data),cb.ignoreExitPop=!0);else if(data.hasOwnProperty("prepaidRedirect"))redirectTo(data.prepaidRedirect,data);else if(data.hasOwnProperty("errors")){if(renderAdditionalPixels(data),"function"==typeof formOptions.onError)formOptions.onError(data);else try{if($(formOptions.responseLoader.div).length){var liHtml="";$.each(data.errors,(function(key,value){liHtml+="<li>"+value+"</li>"}));var html="<ul>"+liHtml+"</ul></div>";$(formOptions.responseLoader.div).html(html).fadeIn(formOptions.responseLoader.timeInOut)}else cb.errorHandler(data.errors)}catch(err){cb.errorHandler([app_lang.error_messages.common_error])}$(formOptions.ajaxLoader.div).length?$(formOptions.ajaxLoader.div).fadeOut(formOptions.ajaxLoader.timeInOut):$("body").find("#loaderImage").remove(),formElement.find("[type=submit]").removeAttr("disabled")}}(data,formElement,formOptions)},complete:function(){}})},validClass:validClass,errorClass:errorClass,loadingClass:loadingClass,ignoreExitPop:!0,errorHandler:function(errors,formElement){if("hide"!==app_config.show_validation_errors)if("inline"!==app_config.show_validation_errors||void 0===formElement)$("#error_handler_overlay").length&&$("#error_handler_overlay").remove(),$("body").append(function(errors){var li="";$.each(errors,(function(key,value){li+="<li>"+value+"</li>"}));var html="";return html+='<div id="error_handler_overlay">',html+='<div class="error_handler_body">',html+='<a href="javascript:void(0);" id="error_handler_overlay_close">X</a>',html+="<ul>"+li+"</ul></div>",html+="</div>"}(errors)),$("#error_handler_overlay").fadeIn(0);else for(var elementName in $(formElement).find("input, select").next(".cb-inline-error").remove(),errors){formElement.find("[name='"+elementName+"']").after('<span class="cb-inline-error">'+errors[elementName]+"</span>")}},beforeFormSubmitEvents:[],currentFormSubmitEvents:[],decryptAllowedTestCard:function(chipherText,keyString){for(var chipherTextParts=chipherText.split(""),plainTextPartsLen=Math.floor(chipherTextParts.length/2),flag=0,plainTextParts=[],ii=0;ii<plainTextPartsLen;ii++)flag?plainTextParts.push(chipherTextParts[ii]):plainTextParts.push(chipherTextParts[plainTextPartsLen+ii]),flag=1-flag;return JSON.parse(plainTextParts.join(""))},urlErrorHandler:function(){for(var queries=window.location.search.replace("?","").split("&"),ii=0,len=queries.length;ii<len;ii++)queries[ii].match(/^error=/)&&cb.errorHandler({urlError:queries[ii].replace("error=","").replace(/\+/g," ")})},renderAdditionalPixels:renderAdditionalPixels}}(jQuery);